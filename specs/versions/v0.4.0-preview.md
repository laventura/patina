# Patina v0.4.0: Split View & Preview

**Status:** Planning
**Target:** Days 6-7
**Dependencies:** v0.3.0

---

## Overview

v0.4.0 implements split-pane layout with live Markdown preview. The editor pane shows raw text, the preview pane shows rendered Markdown.

## Goals

- Split pane layout (edit left, preview right)
- Render AST to ratatui widgets
- Toggle split view (Ctrl+\)
- Basic synchronized scrolling
- Styled rendering (bold, italic, headings, etc.)

## Success Criteria

- [ ] Split view displays correctly
- [ ] Preview renders all basic Markdown
- [ ] Can toggle between edit-only and split view
- [ ] Scrolling works in both panes
- [ ] Rendering updates as you type (debounced)

---

## Implementation

### 1. Rendering Architecture (`patina-render`)

Move rendering logic from `patina/src/ui.rs` to `patina-render`:

```rust
// patina-render/src/tui/mod.rs
pub struct App {
    pub view_mode: ViewMode,
    pub active_pane: Pane,
}

#[derive(Debug, Clone, Copy, PartialEq)]
pub enum ViewMode {
    EditOnly,
    SplitView,
    PreviewOnly,
}

#[derive(Debug, Clone, Copy, PartialEq)]
pub enum Pane {
    Editor,
    Preview,
}
```

### 2. Split Layout (`patina-render/src/tui/app.rs`)

```rust
use ratatui::layout::{Constraint, Direction, Layout};

pub fn layout_split(area: Rect) -> (Rect, Rect) {
    let chunks = Layout::default()
        .direction(Direction::Horizontal)
        .constraints([
            Constraint::Percentage(50),  // Editor
            Constraint::Percentage(50),  // Preview
        ])
        .split(area);

    (chunks[0], chunks[1])
}
```

### 3. Preview Rendering (`patina-render/src/tui/widgets.rs`)

```rust
use comrak::nodes::{AstNode, NodeValue};
use ratatui::text::{Line, Span, Text};
use ratatui::style::{Color, Modifier, Style};

pub fn render_ast_to_text<'a>(node: &'a AstNode<'a>) -> Vec<Line<'a>> {
    let mut lines = Vec::new();
    walk_ast(node, &mut lines, 0);
    lines
}

fn walk_ast<'a>(node: &'a AstNode<'a>, lines: &mut Vec<Line<'a>>, depth: usize) {
    match &node.data.borrow().value {
        NodeValue::Document => {
            for child in node.children() {
                walk_ast(child, lines, depth);
            }
        }

        NodeValue::Heading(heading) => {
            let prefix = "#".repeat(heading.level as usize);
            let mut spans = vec![Span::styled(
                format!("{} ", prefix),
                Style::default().fg(Color::Blue).add_modifier(Modifier::BOLD),
            )];

            for child in node.children() {
                collect_text(child, &mut spans);
            }

            lines.push(Line::from(spans));
            lines.push(Line::from(""));
        }

        NodeValue::Paragraph => {
            let mut spans = Vec::new();
            for child in node.children() {
                collect_text(child, &mut spans);
            }
            lines.push(Line::from(spans));
            lines.push(Line::from(""));
        }

        // ... implement other node types ...

        _ => {}
    }
}

fn collect_text<'a>(node: &'a AstNode<'a>, spans: &mut Vec<Span<'a>>) {
    match &node.data.borrow().value {
        NodeValue::Text(text) => {
            spans.push(Span::raw(text.clone()));
        }
        NodeValue::Strong => {
            let style = Style::default().add_modifier(Modifier::BOLD);
            for child in node.children() {
                // Recursively collect with bold style
            }
        }
        NodeValue::Emph => {
            let style = Style::default().add_modifier(Modifier::ITALIC);
            for child in node.children() {
                // Recursively collect with italic style
            }
        }
        _ => {}
    }
}
```

### 4. Toggle Split View (`patina/src/app.rs`)

```rust
impl App {
    fn handle_key(&mut self, key: event::KeyEvent) -> Result<()> {
        // ... existing code ...

        match (key.code, ctrl) {
            (KeyCode::Char('\\'), true) => {
                // Toggle split view
                self.view_mode = match self.view_mode {
                    ViewMode::EditOnly => ViewMode::SplitView,
                    ViewMode::SplitView => ViewMode::EditOnly,
                    ViewMode::PreviewOnly => ViewMode::SplitView,
                };
            }
            // ...
        }

        Ok(())
    }
}
```

---

## Validation

- [ ] Split view displays correctly on all terminal sizes
- [ ] Preview renders headings, paragraphs, lists, code blocks
- [ ] Bold and italic styling works
- [ ] Toggle between edit-only and split view
- [ ] Scrolling works smoothly
- [ ] Performance: < 50ms render time for 1000-line doc

---

## Next Steps

v0.5.0: Add syntax highlighting to code blocks and frontmatter parsing
