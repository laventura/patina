# Patina v0.5.0: Syntax Highlighting & Frontmatter

**Status:** Planning
**Target:** Days 8-9
**Dependencies:** v0.4.0

---

## Overview

v0.5.0 adds syntax highlighting to code blocks using syntect and implements YAML/TOML frontmatter parsing.

## Goals

- Syntax highlighting for 50+ languages
- YAML frontmatter parsing (`---` delimiters)
- TOML frontmatter parsing (`+++` delimiters)
- Theme system (Dracula, One Dark, Solarized)
- Display frontmatter in preview

## Success Criteria

- [ ] Code blocks are syntax highlighted
- [ ] At least 50 languages supported
- [ ] Frontmatter is extracted and parsed
- [ ] Frontmatter displays in preview
- [ ] Can switch themes
- [ ] Tests for all features

---

## Implementation

### 1. Syntax Highlighting (`patina-core/src/syntax.rs`)

```rust
use syntect::parsing::SyntaxSet;
use syntect::highlighting::{ThemeSet, Style};
use syntect::easy::HighlightLines;

pub struct SyntaxHighlighter {
    syntax_set: SyntaxSet,
    theme_set: ThemeSet,
}

impl SyntaxHighlighter {
    pub fn new() -> Self {
        Self {
            syntax_set: SyntaxSet::load_defaults_newlines(),
            theme_set: ThemeSet::load_defaults(),
        }
    }

    pub fn highlight(&self, lang: &str, code: &str, theme_name: &str) -> Vec<Vec<(Style, String)>> {
        let syntax = self.syntax_set
            .find_syntax_by_token(lang)
            .unwrap_or_else(|| self.syntax_set.find_syntax_plain_text());

        let theme = &self.theme_set.themes[theme_name];
        let mut highlighter = HighlightLines::new(syntax, theme);

        code.lines()
            .map(|line| {
                highlighter
                    .highlight_line(line, &self.syntax_set)
                    .unwrap_or_default()
                    .into_iter()
                    .map(|(style, text)| (style, text.to_string()))
                    .collect()
            })
            .collect()
    }

    pub fn supported_languages(&self) -> Vec<String> {
        self.syntax_set
            .syntaxes()
            .iter()
            .map(|s| s.name.clone())
            .collect()
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_highlight_rust() {
        let highlighter = SyntaxHighlighter::new();
        let code = "fn main() { println!(\"Hello\"); }";
        let highlighted = highlighter.highlight("rust", code, "base16-ocean.dark");
        assert!(!highlighted.is_empty());
    }

    #[test]
    fn test_supported_languages() {
        let highlighter = SyntaxHighlighter::new();
        let langs = highlighter.supported_languages();
        assert!(langs.contains(&"Rust".to_string()));
        assert!(langs.contains(&"Python".to_string()));
        assert!(langs.contains(&"JavaScript".to_string()));
    }
}
```

### 2. Frontmatter Parsing (`patina-core/src/frontmatter.rs`)

```rust
use serde_yaml::Value as YamlValue;
use toml::Value as TomlValue;

#[derive(Debug, Clone)]
pub enum Frontmatter {
    Yaml(serde_json::Value),
    Toml(serde_json::Value),
}

impl Frontmatter {
    /// Extract frontmatter from text
    /// Returns (Option<Frontmatter>, body_text)
    pub fn extract(text: &str) -> (Option<Self>, &str) {
        if text.starts_with("---\n") || text.starts_with("---\r\n") {
            Self::extract_yaml(text)
        } else if text.starts_with("+++\n") || text.starts_with("+++\r\n") {
            Self::extract_toml(text)
        } else {
            (None, text)
        }
    }

    fn extract_yaml(text: &str) -> (Option<Self>, &str) {
        let lines: Vec<&str> = text.lines().collect();
        if lines.is_empty() || !lines[0].starts_with("---") {
            return (None, text);
        }

        // Find closing ---
        if let Some(end_idx) = lines[1..].iter().position(|line| line.trim() == "---") {
            let fm_lines = &lines[1..=end_idx];
            let fm_text = fm_lines.join("\n");

            if let Ok(yaml) = serde_yaml::from_str::<YamlValue>(&fm_text) {
                let json = serde_json::to_value(yaml).ok()?;
                let body_start = text.find(&lines[end_idx + 2])
                    .unwrap_or(text.len());
                let body = &text[body_start..];
                return (Some(Frontmatter::Yaml(json)), body);
            }
        }

        (None, text)
    }

    fn extract_toml(text: &str) -> (Option<Self>, &str) {
        // Similar to YAML but with +++ delimiters
        // Implementation details...
        (None, text)
    }

    pub fn as_json(&self) -> &serde_json::Value {
        match self {
            Frontmatter::Yaml(v) | Frontmatter::Toml(v) => v,
        }
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_extract_yaml() {
        let text = "---\ntitle: Test\nauthor: Me\n---\n\n# Content";
        let (fm, body) = Frontmatter::extract(text);

        assert!(fm.is_some());
        assert_eq!(body.trim(), "# Content");

        let fm = fm.unwrap();
        assert!(matches!(fm, Frontmatter::Yaml(_)));
    }

    #[test]
    fn test_no_frontmatter() {
        let text = "# Just content";
        let (fm, body) = Frontmatter::extract(text);
        assert!(fm.is_none());
        assert_eq!(body, text);
    }
}
```

### 3. Theme System (`patina-render/src/theme.rs`)

```rust
pub enum Theme {
    Dracula,
    OneDark,
    Solarized,
}

impl Theme {
    pub fn by_name(name: &str) -> Self {
        match name {
            "dracula" => Self::Dracula,
            "onedark" | "one-dark" => Self::OneDark,
            "solarized" => Self::Solarized,
            _ => Self::Dracula,
        }
    }

    pub fn syntect_name(&self) -> &str {
        match self {
            Theme::Dracula => "Dracula",
            Theme::OneDark => "OneHalfDark",
            Theme::Solarized => "Solarized (dark)",
        }
    }
}
```

### 4. Integration

Update Document to parse frontmatter on load:
```rust
impl Document {
    pub fn from_str(content: &str) -> Self {
        let (frontmatter, body) = Frontmatter::extract(content);
        Self {
            buffer: Buffer::from_str(body),
            frontmatter,
            // ...
        }
    }
}
```

---

## Validation

- [ ] Syntax highlighting works for Rust, Python, JavaScript, etc.
- [ ] YAML frontmatter parses correctly
- [ ] TOML frontmatter parses correctly
- [ ] Frontmatter displays in preview
- [ ] Can switch themes
- [ ] Tests pass

---

## Next Steps

v0.6.0: Add LaTeX math rendering and polish for MVP
